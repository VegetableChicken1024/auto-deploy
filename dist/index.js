!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["auto-deploy"]=t():e["auto-deploy"]=t()}(global,(()=>(()=>{"use strict";var e={692:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=o(964),r=o(99),a=(0,i.getDeployrc)();n(void 0,void 0,void 0,(function*(){const e=yield(0,r.askConfig)(a.configPaths);yield Promise.allSettled(e.map((e=>(0,i.createSSHConnection)(e))));const t=yield(0,r.askDeployOrRollback)(),o=1!==i.sshMap.size||a.remotePath?a.remotePath:yield(0,r.askRemotePath)(),n=a.localFilePath||(yield(0,r.askLocalFilePath)());if("rollback"===t){if(i.sshMap.size>1)return void console.log("回滚仅支持单配置");const e=yield(0,r.askRemoteFileName)(o);yield(0,i.rollback)(i.sshMap.values().next().value.ssh,o,e)}else{const{fileName:t,filePath:a}=yield(0,r.askLocalZipPath)(n);yield Promise.allSettled(e.map((e=>{var n;const r=null===(n=i.sshMap.get(e.host))||void 0===n?void 0:n.ssh;if(r)return(0,i.deploy)(r,o,a,t)})))}(0,i.closeAllSSHConnection)()}))},998:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}l((n=n.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.askConfig=void 0;const r=i(o(290)),a=o(964),c=r.default.createPromptModule();t.askConfig=e=>n(void 0,void 0,void 0,(function*(){return(yield c([{type:"checkbox",name:"configs",message:"请选择需要部署的配置文件",choices:()=>e.map((e=>({name:e.slice(e.lastIndexOf("/")+1),value:e}))),validate:e=>!!e.length||"配置文件不能为空"}])).configs.map((e=>(0,a.getOption)(e)))}))},236:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}l((n=n.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.askDeployOrRollback=void 0;const r=i(o(290)).default.createPromptModule();t.askDeployOrRollback=()=>n(void 0,void 0,void 0,(function*(){return(yield r([{type:"list",name:"deployOrRollback",message:"请选择操作",choices:[{name:"部署",value:"deploy"},{name:"回滚",value:"rollback"}]}])).deployOrRollback}))},99:function(e,t,o){var n=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,i)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),i=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||n(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),i(o(998),t),i(o(236),t),i(o(619),t),i(o(974),t),i(o(763),t),i(o(554),t)},974:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}l((n=n.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.askLocalFilePath=void 0;const r=i(o(290)).default.createPromptModule();t.askLocalFilePath=()=>n(void 0,void 0,void 0,(function*(){return(yield r([{type:"input",name:"localFilePath",message:"请输入本地文件路径",default:"./buildFiles"}])).localFilePath}))},763:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}l((n=n.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.askLocalZipPath=void 0;const r=i(o(290)),a=o(17),c=o(147),l=r.default.createPromptModule();t.askLocalZipPath=e=>n(void 0,void 0,void 0,(function*(){const t=yield l([{type:"list",name:"localZipPath",choices:()=>(e=>{const t=(0,a.resolve)(process.cwd(),e);if(!(0,c.existsSync)(t))throw new Error("文件夹不存在");return(0,c.readdirSync)(t).filter((e=>e.endsWith(".zip"))).map((e=>({name:e,value:{fileName:e,filePath:(0,a.resolve)(t,e)}})))})(e),message:"请选择要上传的zip包"}]);return t.localZipPath}))},554:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}l((n=n.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.askRemoteFileName=void 0;const r=i(o(290)),a=o(964),c=r.default.createPromptModule();t.askRemoteFileName=e=>n(void 0,void 0,void 0,(function*(){const t=a.sshMap.values().next().value.ssh;return(yield c([{type:"list",name:"remoteFileName",choices:()=>n(void 0,void 0,void 0,(function*(){return(yield(0,a.findZips)(t,e)).map((t=>t.slice(e.length+1)))}))}])).remoteFileName}))},619:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}l((n=n.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.askRemotePath=void 0;const r=i(o(290)),a=o(964),c=r.default.createPromptModule();t.askRemotePath=()=>n(void 0,void 0,void 0,(function*(){const e=a.sshMap.values().next().value.ssh;return(yield c([{type:"input",name:"remoteFolder",message:"请输入项目存放目录(支持自动搜索)",validate:e=>!!e||"目录不能为空"},{type:"list",name:"remotePath",message:"请选择项目部署路径",choices:t=>(0,a.findDirs)(e,t.remoteFolder),when:e=>e.remoteFolder}])).remotePath}))},620:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getOption=t.getDeployrc=t.configMap=void 0;const n=o(17),i=o(147),r=o(66);t.configMap=new Map,t.getDeployrc=()=>{const e=(0,n.join)(process.cwd(),".deployrc.json");return(0,i.existsSync)(e)||(()=>{throw new Error("请在项目根目录下创建.deployrc.json配置文件")})(),JSON.parse((0,i.readFileSync)(e,"utf-8"))},t.getOption=e=>{const o=(0,n.join)(process.cwd(),e);(0,i.existsSync)(o)||(()=>{throw new Error("当前配置文件不存在，请在相关目录进行创建")})();const a=(0,i.readFileSync)(o,"utf-8"),c=(0,r.parse)(a);return t.configMap.set(c.host,c),c}},964:function(e,t,o){var n=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,i)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),i=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||n(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),i(o(620),t),i(o(454),t)},454:function(e,t,o){var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(i,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function c(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}l((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.findZips=t.rollback=t.deploy=t.unzip=t.uploadZip=t.findDirs=t.closeAllSSHConnection=t.closeSSHConnection=t.createSSHConnection=t.sshMap=void 0;const i=o(374),r=o(620),a=["host","port","username","password"];t.sshMap=new Map,t.createSSHConnection=e=>n(void 0,void 0,void 0,(function*(){const o=new i.NodeSSH,n=Object.keys(e).reduce(((t,o)=>(a.includes(o)&&(t[o]=e[o]),t)),{});yield o.connect(n).then((()=>{t.sshMap.set(e.host,{ssh:o})})).catch((t=>{console.log(`${n.host}连接失败：${t}`),r.configMap.delete(e.host)}))})),t.closeSSHConnection=e=>{var o;const n=null===(o=t.sshMap.get(e))||void 0===o?void 0:o.ssh;n&&(n.dispose(),t.sshMap.delete(e))},t.closeAllSSHConnection=()=>{t.sshMap.forEach(((e,o)=>{(0,t.closeSSHConnection)(o)})),t.sshMap.clear()},t.findDirs=(e,t)=>n(void 0,void 0,void 0,(function*(){console.log("正在搜索项目文件夹，请稍候...");const o=`find / -type d -name "*${t}*" -exec test -e {}/index.html \\; -print 2>/dev/null`,{stdout:n}=yield e.execCommand(o);return n?n.split("\n").filter((e=>e)):[]})),t.uploadZip=(e,t,o)=>n(void 0,void 0,void 0,(function*(){console.log("正在上传文件，请稍候..."),yield e.putFile(t,o)})),t.unzip=(e,t,o)=>n(void 0,void 0,void 0,(function*(){console.log("正在解压文件，请稍候...",t,o);const n=`unzip -o ${t+"/"+o} -d ${t}`;yield e.execCommand(n)})),t.deploy=(e,o,i,r)=>n(void 0,void 0,void 0,(function*(){console.log("正在部署项目，请稍候..."),yield(0,t.uploadZip)(e,i,o),yield(0,t.unzip)(e,o,r)})),t.rollback=(e,o,i)=>n(void 0,void 0,void 0,(function*(){console.log("正在回滚项目，请稍候..."),yield(0,t.unzip)(e,o,i)})),t.findZips=(e,t)=>n(void 0,void 0,void 0,(function*(){console.log("正在搜索项目文件夹，请稍候...");const o=`find ${t} -name "*.zip"`,{stdout:n}=yield e.execCommand(o);return n?n.split("\n").filter((e=>e)):[]}))},290:e=>{e.exports=require("inquirer")},374:e=>{e.exports=require("node-ssh")},66:e=>{e.exports=require("yaml")},147:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")}},t={},o=function o(n){var i=t[n];if(void 0!==i)return i.exports;var r=t[n]={exports:{}};return e[n].call(r.exports,r,r.exports,o),r.exports}(692);return o.default})()));